#!/usr/bin/env python3
"""Starter template for the honeypot assignment."""

import logging
import os
import time
import socket
import threading



LOG_PATH = "/app/logs/honeypot.log"

HOST = "0.0.0.0"
PORT = 22

SSH_BANNER = b"SSH-2.0-OpenSSH_8.2p1 Ubuntu-4ubuntu0.5\r\n"


def setup_logging():
    os.makedirs("/app/logs", exist_ok=True)
    logging.basicConfig(
        level=logging.INFO,
        format="%(asctime)s - %(levelname)s - %(message)s",
        handlers=[logging.FileHandler(LOG_PATH), logging.StreamHandler()],
    )

def handle_client(conn, addr):
    logger = logging.getLogger("Honeypot")
    ip, port = addr
    start_time = time.time()

    logger.info(f"Connection from {ip}:{port}")

    try:
        conn.sendall(SSH_BANNER)

        data = conn.recv(1024)
        if data:
            logger.info(f"Data from {ip}: {data.decode(errors='ignore').strip()}")

    except Exception as e:
        logger.error(f"Error handling {ip}: {e}")

    finally:
        conn.close()
        duration = time.time() - start_time
        logger.info(f"Connection closed {ip} duration={duration:.2f}s")

def run_honeypot():
    logger = logging.getLogger("Honeypot")
    server = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    server.bind((HOST, PORT))
    server.listen(5)

    logger.info(f"Honeypot listening on {HOST}:{PORT}")

    while True:
   	 conn, addr = server.accept()
   	 threading.Thread(target=handle_client, args=(conn, addr), daemon=True).start()

if __name__ == "__main__":
    setup_logging()
    run_honeypot()
